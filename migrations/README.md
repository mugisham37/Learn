# Database Migrations

This directory contains database migration files generated by Drizzle Kit.

## Migration Files

- `0000_romantic_grandmaster.sql` - Initial database schema migration
  - Creates all 24 tables for the learning platform
  - Defines 16 enum types for various status fields
  - Sets up all foreign key relationships with cascade delete
  - Creates indexes for optimized query performance

## Running Migrations

### Prerequisites

1. Ensure PostgreSQL is running (via Docker or local installation)
2. Verify DATABASE_URL is set in `.env` file
3. Database should be created (default: `learning_platform`)

### Start Database Services

```bash
# Start PostgreSQL and Redis using Docker Compose
npm run docker:up

# Or manually start just the database
docker-compose up -d postgres
```

### Run Migrations

```bash
# Run all pending migrations
npm run db:migrate

# Or use the migration script directly
tsx src/infrastructure/database/migrate.ts
```

### Verify Migration

After running migrations, verify the schema was created correctly:

```bash
# Connect to the database
psql postgresql://postgres:password@localhost:5432/learning_platform

# List all tables
\dt

# Describe a specific table
\d users

# List all enums
\dT

# Exit psql
\q
```

You can also use PgAdmin (available at http://localhost:5050 when Docker is running):
- Email: admin@learningplatform.com
- Password: admin

## Migration Rollback

To rollback the initial migration, run the rollback script:

```bash
# Rollback the initial migration
psql postgresql://postgres:password@localhost:5432/learning_platform -f migrations/rollback/0000_rollback.sql
```

**WARNING**: Rollback will drop all tables and data. Use with caution!

## Generating New Migrations

When schema changes are made:

```bash
# Generate a new migration
npm run db:generate

# Review the generated SQL in migrations/ directory
# Then run the migration
npm run db:migrate
```

## Database Schema Overview

### Core Tables

**Users & Authentication**
- `users` - User accounts with authentication credentials
- `user_profiles` - Extended user profile information

**Courses & Content**
- `courses` - Course metadata and configuration
- `course_modules` - Logical grouping of lessons
- `lessons` - Individual learning units (video, text, quiz, assignment)

**Enrollments & Progress**
- `enrollments` - Student-course relationships
- `lesson_progress` - Granular progress tracking per lesson
- `certificates` - Digital certificates for course completion

**Assessments**
- `quizzes` - Quiz configuration and settings
- `questions` - Individual quiz questions
- `quiz_submissions` - Student quiz attempts and scores
- `assignments` - Assignment configuration
- `assignment_submissions` - Student assignment submissions

**Communication**
- `messages` - Direct messages between users
- `discussion_threads` - Course forum threads
- `discussion_posts` - Forum posts and replies
- `announcements` - Course announcements

**Notifications**
- `notifications` - Multi-channel notification records

**Analytics**
- `course_analytics` - Aggregated course metrics
- `student_analytics` - Aggregated student metrics
- `analytics_events` - Raw event tracking data

**Payments**
- `payments` - Transaction records
- `subscriptions` - Recurring payment subscriptions
- `refunds` - Refund transactions

## Troubleshooting

### Migration Fails

If migration fails:

1. Check database connection:
   ```bash
   psql postgresql://postgres:password@localhost:5432/learning_platform -c "SELECT 1"
   ```

2. Check for existing tables:
   ```bash
   psql postgresql://postgres:password@localhost:5432/learning_platform -c "\dt"
   ```

3. If tables exist, you may need to drop them or use rollback script

### Connection Refused

If you get "connection refused":

1. Ensure Docker is running
2. Check if PostgreSQL container is running:
   ```bash
   docker ps | grep postgres
   ```

3. Start the container if needed:
   ```bash
   docker-compose up -d postgres
   ```

### Permission Denied

If you get permission errors:

1. Check DATABASE_URL credentials in `.env`
2. Verify PostgreSQL user has necessary permissions
3. Try connecting manually with psql to test credentials

## Best Practices

1. **Always review generated SQL** before running migrations
2. **Backup production data** before running migrations
3. **Test migrations** in development/staging first
4. **Use transactions** for complex migrations (Drizzle does this automatically)
5. **Document schema changes** in migration commit messages
6. **Never modify existing migrations** - create new ones instead
7. **Keep migrations small** and focused on specific changes
